language: python
python:
  - "3.11"
dist: focal
os: linux

services:
  - postgresql

env:
  - BASE_PATH="backend/nightwalkers" FRONTEND_PATH="frontend"

before_install:
  - sudo apt-get update -qq
  - sudo apt-get install -y gdal-bin postgis postgresql-13-postgis-3

cache:
  directories:
    - ~/.cache/pip
    - ~/.npm
    - ~/.cache/npm
    - frontend/node_modules
    - frontend/build
    - frontend/.next/cache
  npm: true
  pip: true

install:
  - pip install -r backend/nightwalkers/requirements.txt
  - pip install black flake8 coverage coveralls
  - nvm install 22.9
  - npm install -g npm@10.8
  - cd $FRONTEND_PATH && npm install && cd ..

before_script:
  - chmod +x deploy.sh
  - chmod +x deploy-to-production.sh
  - chmod +x deploy-to-develop.sh
  - chmod +x deploy-to-netlify.sh
  - psql -c 'DROP DATABASE IF EXISTS nightwalkers_test;' -U postgres
  - psql -c 'CREATE DATABASE nightwalkers_test;' -U postgres
  - psql -c 'CREATE EXTENSION IF NOT EXISTS postgis;' -U postgres -d nightwalkers_test || echo "Warning: Could not create PostGIS extension"

script:
  - pwd
  - black --check backend/nightwalkers/
  - flake8 backend/nightwalkers/
  - coverage run --source=$BASE_PATH $BASE_PATH/manage.py test $BASE_PATH
  - coverage report
  - coverage xml
  - cd $FRONTEND_PATH && npm run build && cd ..

after_success:
  - coveralls --service=travis-pro

deploy:
  provider: script
  script: ./deploy.sh
  cleanup: false
  on:
    all_branches: true
    condition: $TRAVIS_BRANCH =~ ^(main|develop)$

notifications:
  email:
    on_success: never
    on_failure: always